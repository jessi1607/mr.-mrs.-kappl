<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lena & Franz - 27.09.2025</title>
<style>
  body {
    background: white;
    font-family: 'Georgia', serif;
    color: #2a4d2a;
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 { color: #50C878; font-size: 2.5rem; margin-bottom: 0; }
  #cameraContainer {
    position: relative;
    width: 95vw;
    max-width: 700px;
    aspect-ratio: 4 / 3;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 20px;
    background: black;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  video, #photo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
    position: absolute;
    top: 0; left: 0;
    z-index: 5;
  }
  #photo { z-index: 10; display: none; }
  #canvas { display: none; }
  .buttonRow {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 15px 0 10px;
    flex-direction: row;
  }
  button {
    background-color: #50C878;
    color: #2a4d2a;
    border: 2px solid #50C878;
    border-radius: 6px;
    padding: 12px 20px;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(80, 200, 120, 0.6);
    transition: background-color 0.3s ease, color 0.3s ease;
    min-width: 120px;
  }
  button:hover { background-color: #3cae68; color: white; border-color: #3cae68; }
  #message { margin-top: 15px; font-weight: bold; color: #2a4d2a; min-height: 1.2em; }
  input[type="file"] { display: none; }
</style>
</head>
<body>
<h1>Lena & Franz - 27.09.2025</h1>

<div id="cameraContainer">
  <video id="video" autoplay playsinline></video>
  <img id="photo" alt="Aufgenommenes Foto" />
</div>
<canvas id="canvas"></canvas>

<div class="buttonRow">
  <button id="frontBtn">Frontkamera</button>
  <button id="backBtn">R√ºckkamera</button>
</div>

<div class="buttonRow">
  <button id="takePhotoBtn">üì∏ Foto machen</button>
  <button id="selectImageBtn">üñº Bild aus Galerie</button>
</div>

<div class="buttonRow">  
  <button id="uploadBtn" disabled>‚¨ÜÔ∏è Hochladen</button>
  <button id="saveBtn" disabled>üíæ Speichern</button>
</div>

<input type="file" id="fileInput" accept="image/*" />
<div id="message"></div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const photo = document.getElementById('photo');
const message = document.getElementById('message');
const fileInput = document.getElementById('fileInput');

let currentStream = null;
let currentFacingMode = 'user';
let capturedImageBlob = null;

// Kamera starten
async function startCamera(facingMode) {
  if (currentStream) currentStream.getTracks().forEach(track => track.stop());

  try {
    currentStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: facingMode } },
      audio: false
    });
  } catch {
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: false
      });
    } catch (err) {
      console.error('Kamera konnte nicht gestartet werden:', err);
      message.textContent = 'Kamera konnte nicht gestartet werden.';
      return;
    }
  }

  video.srcObject = currentStream;
  video.style.transform = (facingMode === 'user') ? 'scaleX(-1)' : 'scaleX(1)';
  currentFacingMode = facingMode;
  message.textContent = '';
  photo.style.display = 'none';
  video.style.display = 'block';
  document.getElementById('uploadBtn').disabled = true;
  document.getElementById('saveBtn').disabled = true;
  photo.src = '';
  capturedImageBlob = null;
}

document.getElementById('frontBtn').addEventListener('click', () => startCamera('user'));
document.getElementById('backBtn').addEventListener('click', () => startCamera('environment'));

// Foto aufnehmen
document.getElementById('takePhotoBtn').addEventListener('click', () => {
  if (!currentStream) { message.textContent = 'Bitte erst Kamera ausw√§hlen.'; return; }
  const width = video.videoWidth;
  const height = video.videoHeight;
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  if (currentFacingMode === 'user') { ctx.translate(width,0); ctx.scale(-1,1); }
  ctx.drawImage(video,0,0,width,height);
  ctx.setTransform(1,0,0,1,0,0);

  canvas.toBlob(blob => {
    capturedImageBlob = blob;
    photo.src = URL.createObjectURL(blob);
    photo.style.display = 'block';
    video.style.display = 'none';
    document.getElementById('uploadBtn').disabled = false;
    document.getElementById('saveBtn').disabled = false;
    message.textContent = 'Foto aufgenommen. Jetzt Hochladen oder Speichern klicken.';
  }, 'image/jpeg', 0.95);
});

// Bild aus Galerie
document.getElementById('selectImageBtn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (!file) return;
  capturedImageBlob = file;
  photo.src = URL.createObjectURL(file);
  photo.style.display = 'block';
  video.style.display = 'none';
  document.getElementById('uploadBtn').disabled = false;
  document.getElementById('saveBtn').disabled = false;
  message.textContent = 'Bild aus Galerie ausgew√§hlt. Jetzt Hochladen oder Speichern klicken.';
});

// Upload √ºber die Vercel-API
document.getElementById('uploadBtn').addEventListener('click', async () => {
  if (!capturedImageBlob) { message.textContent = 'Bitte erst ein Foto machen oder ausw√§hlen.'; return; }

  message.textContent = 'Lade Bild hoch...';

  try {
    const response = await fetch("/api/upload", {
      method: "POST",
      body: capturedImageBlob
    });

    const result = await response.json();
    if (result.success) {
      message.style.color = '#2a4d2a';
      message.textContent = 'Bild erfolgreich hochgeladen!';
    } else {
      throw new Error(result.error || "Unbekannter Fehler");
    }
  } catch (error) {
    message.style.color = 'red';
    message.textContent = 'Fehler beim Upload: ' + error.message;
  }
});

// Bild lokal speichern
document.getElementById('saveBtn').addEventListener('click', () => {
  if (!capturedImageBlob) { message.textContent = 'Bitte erst ein Foto machen oder ausw√§hlen.'; return; }
  const a = document.createElement('a');
  a.href = URL.createObjectURL(capturedImageBlob);
  a.download = `LenaFranz_${Date.now()}.jpg`;
  a.click();
});

// Optional: code aus URL f√ºr Exchange API abfangen (nur einmal n√∂tig, falls du refresh_token holen willst)
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get("code");
if (code) {
  fetch(`/api/exchange-code?code=${code}`)
    .then(res => res.json())
    .then(data => console.log("Refresh Token erhalten:", data.refresh_token))
    .catch(err => console.error(err));
}

startCamera('user');
</script>
</body>
</html>
